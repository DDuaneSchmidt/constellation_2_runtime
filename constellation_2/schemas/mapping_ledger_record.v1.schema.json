{
  "$id": "https://constellation.local/schemas/mapping_ledger_record.v1.schema.json",
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "MappingLedgerRecord v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_id",
    "schema_version",
    "record_id",
    "created_at_utc",
    "intent_hash",
    "chain_snapshot_hash",
    "freshness_cert_hash",
    "plan_hash",
    "selection_trace",
    "canonical_json_hash"
  ],
  "properties": {
    "schema_id": { "const": "mapping_ledger_record" },
    "schema_version": { "const": "v1" },

    "record_id": {
      "type": "string",
      "minLength": 16,
      "maxLength": 128,
      "description": "Deterministic record identifier (hash-derived preferred)."
    },

    "created_at_utc": { "type": "string", "format": "date-time" },

    "intent_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "chain_snapshot_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "freshness_cert_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
    "plan_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },

    "selection_trace": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "expiry_choice",
        "strike_choice",
        "liquidity_filter",
        "tie_breakers"
      ],
      "properties": {
        "expiry_choice": {
          "type": "object",
          "additionalProperties": false,
          "required": ["policy", "selected_expiry_utc", "candidates_considered"],
          "properties": {
            "policy": { "type": "string", "minLength": 1, "maxLength": 200 },
            "selected_expiry_utc": { "type": "string", "format": "date-time" },
            "candidates_considered": { "type": "integer", "minimum": 1, "maximum": 100000 }
          }
        },
        "strike_choice": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "width_points",
            "short_leg_contract_key",
            "long_leg_contract_key"
          ],
          "properties": {
            "width_points": { "type": "string", "pattern": "^[0-9]+(\\.[0-9]+)?$" },
            "short_leg_contract_key": { "type": "string", "minLength": 1, "maxLength": 128 },
            "long_leg_contract_key": { "type": "string", "minLength": 1, "maxLength": 128 }
          }
        },
        "liquidity_filter": {
          "type": "object",
          "additionalProperties": false,
          "required": ["min_open_interest", "min_volume", "max_bid_ask_spread"],
          "properties": {
            "min_open_interest": { "type": "integer", "minimum": 0 },
            "min_volume": { "type": "integer", "minimum": 0 },
            "max_bid_ask_spread": { "type": "string", "pattern": "^[0-9]+(\\.[0-9]+)?$" }
          }
        },
        "tie_breakers": {
          "type": "array",
          "minItems": 1,
          "items": { "type": "string", "minLength": 1, "maxLength": 200 },
          "description": "Ordered list of tie-break rules applied, in sequence."
        }
      }
    },

    "canonical_json_hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" }
  }
}
